- name: Set hostname
  hostname:
    name: mason.wildeagle.net
  register: hostname

- name: Reboot if hostname updated
  shell: 'sleep 1 && reboot && sleep 1'
  async: 1
  poll: 0
  when: hostname is changed

- name: Wait for server to restart
  local_action:
    module: wait_for
      host=mason
      port=22
      delay=1
      timeout=30
  when: hostname is changed

- name: Disable SELinux
  selinux:
    state: disabled
  register: selinux

- name: Reboot if SELinux state changed
  shell: 'sleep 1 && reboot && sleep1'
  async: 1
  poll: 0
  when: selinux is changed

- name: Download iRedMail package
  get_url:
    url: https://bitbucket.org/zhb/iredmail/downloads/iRedMail-0.9.8.tar.bz2
    dest: /tmp/iRedMail-0.9.8.tar.bz2

- name: Make sure bzip2 is installed
  yum: name=bzip2 state=installed

- name: Extract archive
  unarchive:
    src: /tmp/iRedMail-0.9.8.tar.bz2
    dest: /tmp
    remote_src: yes
